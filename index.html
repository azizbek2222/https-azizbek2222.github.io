<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>AI Chat Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://sad.adsgram.ai/js/sad.min.js"></script>

<style>
:root {
    --primary: #10b981;
    --primary-hover: #059669;
    --bg: #0f172a;
    --ai-bg: #1e293b;
    --user-bg: linear-gradient(135deg, #10b981 0%, #059669 100%);
    --text-main: #f1f5f9;
    --text-muted: #94a3b8;
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

body { 
    margin: 0; 
    font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif; 
    background: var(--bg); 
    color: var(--text-main); 
    height: 100vh; 
    display: flex; 
    flex-direction: column; 
    overflow: hidden; 
}

.chat-box { 
    flex: 1; 
    overflow-y: auto; 
    padding: 20px; 
    display: flex; 
    flex-direction: column; 
    gap: 16px;
    scroll-behavior: smooth;
}

.chat-box::-webkit-scrollbar { width: 4px; }
.chat-box::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

.msg { 
    max-width: 85%; 
    padding: 12px 16px; 
    border-radius: 18px; 
    line-height: 1.6; 
    word-wrap: break-word; 
    white-space: pre-wrap; 
    font-size: 15px; 
    position: relative;
    box-shadow: var(--shadow);
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.user { 
    background: var(--user-bg); 
    color: #fff; 
    align-self: flex-end; 
    border-bottom-right-radius: 4px; 
}

.ai { 
    background: var(--ai-bg); 
    color: var(--text-main); 
    align-self: flex-start; 
    border-bottom-left-radius: 4px; 
    border: 1px solid #334155; 
}

.text-copy-btn {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-bottom: 8px;
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-muted);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
}

.text-copy-btn:hover { background: rgba(255, 255, 255, 0.1); color: #fff; }

.code-box { 
    background: #010409; 
    border-radius: 10px; 
    margin-top: 10px; 
    border: 1px solid #30363d; 
    overflow: hidden;
    width: 100%;
}

.code-header {
    background: #161b22;
    padding: 8px 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #30363d;
}

.code-header span { font-size: 12px; color: #8b949e; font-family: 'Fira Code', monospace; }

.code-box pre { 
    margin: 0; 
    padding: 16px; 
    overflow-x: auto; 
    font-family: 'Consolas', 'Monaco', monospace; 
    font-size: 13.5px; 
    color: #7ee787; 
}

.copy-btn { 
    background: #21262d; 
    color: #c9d1d9; 
    border: 1px solid #30363d; 
    border-radius: 6px; 
    padding: 4px 10px; 
    font-size: 11px; 
    cursor: pointer;
    transition: 0.2s;
}

.copy-btn:hover { background: #30363d; border-color: #8b949e; }
.copy-btn:active, .text-copy-btn:active { transform: scale(0.95); background: var(--primary); color: #fff; }

.input-area { 
    background: #1e293b; 
    padding: 16px; 
    display: flex; 
    gap: 12px; 
    align-items: flex-end; 
    border-top: 1px solid #334155;
    box-shadow: 0 -4px 15px rgba(0,0,0,0.2);
}

textarea { 
    flex: 1; 
    background: #0f172a; 
    color: #fff; 
    border: 1px solid #475569; 
    border-radius: 12px; 
    padding: 12px 16px; 
    font-size: 15px; 
    resize: none; 
    min-height: 44px; 
    max-height: 150px; 
    outline: none;
    transition: border-color 0.2s;
}

textarea:focus { border-color: var(--primary); }

button#sendBtn { 
    background: var(--user-bg); 
    border: none; 
    border-radius: 12px; 
    width: 48px; 
    height: 44px; 
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
}

button#sendBtn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
button#sendBtn svg { fill: #fff; width: 22px; height: 22px; }
</style>
</head>
<body>

<div id="chat" class="chat-box"></div>

<div class="input-area">
  <textarea id="q" placeholder="Xabaringizni yozing..."></textarea>
  <button id="sendBtn">
    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
  </button>
</div>

<script>
// --- AdsGram ---
const AdController = window.Adsgram ? window.Adsgram.init({ blockId: "int-19912" }) : null;
function showAds() { if(AdController) AdController.show().catch(() => {}); }

// --- Firebase ---
const firebaseConfig = {
  apiKey: "AIzaSyBrMKJ4MPilQg6gZsaE-Hlqlgo5F4Q8IsM",
  authDomain: "xabar-tizimi.firebaseapp.com",
  databaseURL: "https://xabar-tizimi-default-rtdb.firebaseio.com",
  projectId: "xabar-tizimi",
  storageBucket: "xabar-tizimi.firebasestorage.app",
  messagingSenderId: "3947028451",
  appId: "1:3947028451:web:a064cb657fcf28f6520ad6",
  measurementId: "G-RCMHD7ZPNJ"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let userId = localStorage.getItem("chat_user_id") || "user_" + Math.random().toString(36).substr(2, 9);
localStorage.setItem("chat_user_id", userId);
const chatRef = db.ref("messages/" + userId);

const chatDiv = document.getElementById("chat");
const qInput = document.getElementById("q");
const sendBtn = document.getElementById("sendBtn");

function copyToClipboard(btn, text) {
    if (!navigator.clipboard) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand("copy");
        document.body.removeChild(textArea);
        btn.innerText = "Nusxalandi!";
        setTimeout(() => btn.innerText = "Nusxalash", 2000);
        return;
    }
    navigator.clipboard.writeText(text).then(() => {
        const originalText = btn.innerText;
        btn.innerText = "Nusxalandi!";
        setTimeout(() => btn.innerText = originalText, 2000);
    });
}

function addMessageToUI(obj) {
    const msgDiv = document.createElement("div");
    msgDiv.className = "msg " + obj.cls;

    if (obj.cls === "ai" && obj.text) {
        const tCopyBtn = document.createElement("button");
        tCopyBtn.className = "text-copy-btn";
        tCopyBtn.innerHTML = `<span>Nusxalash</span>`;
        tCopyBtn.onclick = () => copyToClipboard(tCopyBtn, obj.text);
        msgDiv.appendChild(tCopyBtn);
    }

    if (obj.text) {
        const textSpan = document.createElement("span");
        textSpan.innerText = obj.text;
        msgDiv.appendChild(textSpan);
    }

    if (obj.codes && obj.codes.length > 0) {
        obj.codes.forEach(codeText => {
            const codeBox = document.createElement("div");
            codeBox.className = "code-box";
            codeBox.innerHTML = `
                <div class="code-header">
                    <span>Source Code</span>
                    <button class="copy-btn">Copy</button>
                </div>
                <pre><code>${codeText}</code></pre>
            `;
            const cBtn = codeBox.querySelector(".copy-btn");
            cBtn.onclick = () => copyToClipboard(cBtn, codeText);
            msgDiv.appendChild(codeBox);
        });
    }

    chatDiv.appendChild(msgDiv);
    chatDiv.scrollTop = chatDiv.scrollHeight;
}

chatRef.on("child_added", (s) => addMessageToUI(s.val()));

async function send() {
    const text = qInput.value.trim();
    if (!text) return;

    chatRef.push({ text: text, codes: [], cls: "user" });
    qInput.value = "";
    qInput.style.height = "44px";

    const loading = document.createElement("div");
    loading.className = "msg ai";
    loading.innerText = "⏳ O'ylayapman...";
    chatDiv.appendChild(loading);
    chatDiv.scrollTop = chatDiv.scrollHeight;

    try {
        const safeText = text.length > 6500 ? text.substring(0, 6500) : text;
        // BU YERDA SYSTEM PROMPT TREYDINGGA O'ZGARTIRILDI
        const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(safeText)}?model=openai&system=`);
        
        if (!response.ok) {
            throw new Error(`Server xatosi: ${response.status}`);
        }

        const data = await response.text();
        if (chatDiv.contains(loading)) chatDiv.removeChild(loading);

        let mainText = data;
        const codes = [];
        const regex = /```(?:[a-z0-9]*)\n([\s\S]*?)```/g;
        let match;
        while ((match = regex.exec(data)) !== null) {
            codes.push(match[1].trim());
            mainText = mainText.replace(match[0], "");
        }

        chatRef.push({
            text: mainText.trim() || "Natija:",
            codes: codes,
            cls: "ai"
        });

        if (Math.random() > 0.7) showAds();

    } catch (e) {
        if (chatDiv.contains(loading)) chatDiv.removeChild(loading);
        const errorMsg = "⚠️ Server band yoki aloqa uzildi (502). Iltimos, birozdan so'ng qayta urinib ko'ring.";
        addMessageToUI({ text: errorMsg, cls: "ai" });
        console.error("Xatolik:", e);
    }
}

sendBtn.onclick = send;

qInput.oninput = function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
};
</script>
</body>
</html>
